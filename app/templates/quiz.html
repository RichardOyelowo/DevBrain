{% extends "layout.html" %}

{% block title %}: Quiz{% endblock %}

{% block body %}
    {% if data %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const answer_list = document.querySelectorAll(".users_answer");
                
                function decodeHTML(html) {
                    const txt = document.createElement('textarea');
                    txt.innerHTML = html;
                    return txt.value;
                }
                
                const correct_answer = decodeHTML("{{ data['correct_answer']|forceescape }}");
                const explanation = decodeHTML("{{ data.get('explanation', 'No explanation available')|forceescape }}");
                let answered = false;

                answer_list.forEach(answer => {
                    answer.addEventListener("click", function() {
                        if (answered) return;
                        answered = true;
                        
                        answer_list.forEach(btn => {
                            btn.style.pointerEvents = "none";
                        });

                        const selectedAnswer = this.dataset.answer.trim();
                        const correct = correct_answer.trim();

                        document.getElementById("user-answer").value = selectedAnswer;

                        if (selectedAnswer.toLowerCase() === correct.toLowerCase()) {
                            this.style.background = "green";
                        } else {
                            this.style.background = "red";
                            answer_list.forEach(btn => {
                                if (btn.dataset.answer.trim().toLowerCase() === correct.toLowerCase()) {
                                    btn.style.background = "green";
                                }
                            });
                        }

                        this.parentElement.querySelector(".feedback").innerHTML = explanation;
                        document.getElementById("next-btn").style.display = "block";
                    }); 
                });
            });
        </script>
        <form action="/quiz" method="post">

            <input type="hidden" name="answer" id="user-answer" value="">

            <div class="Question-section">
                <h4>{{ data["text"] }}</h4>
                <p>{{ data.get('description', 'No description available') }}</p>
                <div class="d-grid gap-2">
                    {% for answer in answers %}
                        <button type="button" data-answer="{{ answer|e }}" class="users_answer btn btn-primary btn-lg">{{ answer.capitalize() }}</button>
                    {% endfor %}
                    <p class="feedback mt-3"></p>
                </div>

                <button type="submit" id="next-btn" class="btn btn-success mt-3" style="display: none;">Next Question</button>
            </div>
        </form>

    {% elif topics %}
        <form action="/quiz" method="post">
            <div class="topic-section">
                <h2>Choose a Topic:</h2>
                <div class="topic-grid">
                    {% for topic in topics %}
                        <label>
                            <input type="checkbox" name="topics" value="{{ topic }}">
                            <span class="topic-content">
                                <span class="topic-name">{{ topic.capitalize() }}</span>
                            </span>
                        </label>
                    {% endfor %}
                </div>
            </div>
            <div class="difficulty-section">
                <h2>Select Difficulty Level:</h2>
                <div class="difficulty-grid">
                    <label class="difficulty-easy">
                        <input type="radio" name="difficulty" value="Easy">
                        <span class="difficulty-content">
                            <span class="difficulty-name">Easy</span>
                        </span>
                    </label>
                    <label class="difficulty-medium">
                        <input type="radio" name="difficulty" value="Medium">
                        <span class="difficulty-content">
                            <span class="difficulty-name">Medium</span>
                        </span>
                    </label>
                    <label class="difficulty-hard">
                        <input type="radio" name="difficulty" value="Hard">
                        <span class="difficulty-content">
                            <span class="difficulty-name">Hard</span>
                        </span>
                    </label>
                </div>
            </div>
            <div class="count-sections">
                <h2>Number of Questions:</h2>
                <input type="number" name="limit" placeholder="Questions Count" min="1" max="50" required>
            </div>

            <button type="submit" class="btn btn-primary fw-bold">Start Quiz</button>
        </form>
    {% endif %}
{% endblock %}